name: ğŸš€ Terraform Deploy â€“ GCP BigQuery Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      destroy:
        description: "ğŸ§¨ Ejecutar terraform destroy"
        required: false
        default: "false"

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      TF_LOG: TRACE
      TF_LOG_PATH: terraform/terraform-debug.log

    steps:
      # ================================================
      # ğŸ§© 0. PreparaciÃ³n del entorno
      # ================================================
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4

      - name: ğŸ§  Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: ğŸ§° ConfiguraciÃ³n del entorno
        run: |
          echo -e "\033[1;34mğŸ” Verificando entorno...\033[0m"
          terraform -version
          echo -e "\033[1;34mâœ… Entorno validado correctamente.\033[0m"

      - name: ğŸ—‚ Crear carpeta y archivo de logs
        run: |
          echo -e "\033[1;34mğŸ“ Creando estructura de trabajo...\033[0m"
          mkdir -p terraform
          touch terraform/terraform-debug.log
          echo -e "\033[1;32mâœ… Carpeta 'terraform/' y archivo de log creados correctamente.\033[0m"

      # ================================================
      # ğŸ” 1. InicializaciÃ³n
      # ================================================
      - name: ğŸš€ Terraform Init
        working-directory: terraform
        run: |
          echo -e "\033[1;33mğŸ“¦ Iniciando Terraform...\033[0m"
          terraform init -input=false -no-color
          echo -e "\033[1;32mâœ… InicializaciÃ³n completada.\033[0m"

      # ================================================
      # ğŸ§ª 2. ValidaciÃ³n de sintaxis
      # ================================================
      - name: ğŸ§© Terraform Validate
        working-directory: terraform
        run: |
          echo -e "\033[1;33mğŸ” Validando configuraciÃ³n...\033[0m"
          terraform validate -no-color
          echo -e "\033[1;32mâœ… ValidaciÃ³n completada.\033[0m"

      # ================================================
      # ğŸ“Š 3. Plan de ejecuciÃ³n
      # ================================================
      - name: ğŸ“‹ Terraform Plan
        working-directory: terraform
        run: |
          echo -e "\033[1;33mğŸ§® Generando plan de ejecuciÃ³n...\033[0m"
          terraform plan -no-color \
            -var="google_credentials=$GOOGLE_CREDENTIALS"
          echo -e "\033[1;32mâœ… Plan generado correctamente.\033[0m"

      # ================================================
      # ğŸš¢ 4. AplicaciÃ³n o destrucciÃ³n
      # ================================================
      - name: ğŸš¢ Terraform Apply / Destroy
        if: github.event.inputs.destroy != 'true'
        working-directory: terraform
        run: |
          echo -e "\033[1;36mğŸš€ Ejecutando Terraform Apply...\033[0m"
          terraform apply -auto-approve -no-color \
            -var="google_credentials=$GOOGLE_CREDENTIALS"
          echo -e "\033[1;32mâœ… Despliegue completado exitosamente.\033[0m"

      - name: ğŸ§¨ Terraform Destroy
        if: github.event.inputs.destroy == 'true'
        working-directory: terraform
        run: |
          echo -e "\033[1;31mğŸ§¨ Ejecutando Terraform Destroy...\033[0m"
          terraform destroy -auto-approve -no-color \
            -var="google_credentials=$GOOGLE_CREDENTIALS"
          echo -e "\033[1;32mğŸ§¹ Entorno limpiado correctamente.\033[0m"

      # ================================================
      # ğŸ§¾ 5. Logging y diagnÃ³stico post-ejecuciÃ³n
      # ================================================
      - name: ğŸªµ Publicar Logs
        if: always()
        working-directory: terraform
        run: |
          echo -e "\033[1;35mğŸ“œ Ãšltimos 20 registros de Terraform:\033[0m"
          tail -n 20 terraform-debug.log || echo "No hay archivo de log"
          echo -e "\033[1;35mğŸ”— Guardando logs como artefacto...\033[0m"
        continue-on-error: true

      - name: ğŸ’¾ Subir logs como artefacto
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: terraform-logs
          path: terraform/terraform-debug.log
          if-no-files-found: ignore
