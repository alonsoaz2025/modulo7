name: ğŸ” Validate GCP Service Account Link

on:
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}

    steps:
      # ================================================
      # ğŸ§± 0. Clonar repositorio
      # ================================================
      - name: ğŸ§© Checkout
        uses: actions/checkout@v4

      # ================================================
      # ğŸ” 1. Crear archivo temporal con credenciales
      # ================================================
      - name: ğŸ”‘ Generar archivo de credenciales temporal
        run: |
          echo "$GOOGLE_CREDENTIALS" > sa.json
          echo -e "\033[1;32mâœ… Archivo sa.json generado correctamente.\033[0m"

      # ================================================
      # ğŸ§  2. Activar cuenta de servicio y extraer project_id
      # ================================================
      - name: ğŸ§­ Activar cuenta de servicio
        run: |
          echo -e "\033[1;34mğŸ” Activando cuenta de servicio...\033[0m"
          gcloud auth activate-service-account --key-file=sa.json
          PROJECT_ID=$(jq -r '.project_id' sa.json)
          echo "PROJECT_ID=$PROJECT_ID" >> $GITHUB_ENV
          echo -e "\033[1;32mâœ… AutenticaciÃ³n exitosa para el proyecto: $PROJECT_ID\033[0m"

      # ================================================
      # ğŸ’³ 3. Validar facturaciÃ³n activa
      # ================================================
      - name: ğŸ’° Validar billing asociado al proyecto
        run: |
          echo -e "\033[1;33mğŸ’³ Validando cuenta de billing...\033[0m"
          BILLING=$(gcloud beta billing projects describe "$PROJECT_ID" --format="value(billingEnabled)")
          if [ "$BILLING" = "True" ] || [ "$BILLING" = "true" ]; then
            echo -e "\033[1;32mâœ… Billing activo en el proyecto $PROJECT_ID\033[0m"
          else
            echo -e "\033[1;31mâŒ Billing no activo. Asocia la cuenta de facturaciÃ³n antes de continuar.\033[0m"
            exit 1
          fi

      # ================================================
      # ğŸŒ 4. Validar acceso a APIs requeridas
      # ================================================
      - name: ğŸŒ Validar APIs activas
        run: |
          echo -e "\033[1;33mğŸŒ Verificando APIs necesarias...\033[0m"
          gcloud services list --enabled --project="$PROJECT_ID" | grep -E 'bigquery|storage' || echo "âš ï¸ Algunas APIs podrÃ­an no estar habilitadas."
          echo -e "\033[1;32mâœ… ValidaciÃ³n de APIs completada.\033[0m"

      # ================================================
      # ğŸ“¦ 5. Validar acceso a BigQuery y Cloud Storage
      # ================================================
      - name: ğŸ“Š Validar acceso a BigQuery y Storage
        run: |
          echo -e "\033[1;33mğŸ“¦ Validando permisos operativos...\033[0m"
          echo -e "\033[1;34mğŸ” Listando buckets...\033[0m"
          gcloud storage buckets list --project="$PROJECT_ID" --limit=3 || echo "âš ï¸ Sin acceso a buckets o no existen."
          echo -e "\033[1;34mğŸ” Listando datasets de BigQuery...\033[0m"
          bq ls --project_id="$PROJECT_ID" --max_results=3 || echo "âš ï¸ Sin acceso a datasets o no existen."
          echo -e "\033[1;32mâœ… ValidaciÃ³n de acceso completada.\033[0m"

      # ================================================
      # ğŸ§¹ 6. Limpieza segura
      # ================================================
      - name: ğŸ§¹ Eliminar credenciales temporales
        if: always()
        run: |
          rm -f sa.json
          echo -e "\033[1;34mğŸ§¹ Credenciales temporales eliminadas.\033[0m"
